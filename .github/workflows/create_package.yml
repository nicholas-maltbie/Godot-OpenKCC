name: ðŸ“¦ Create Addon Package
on:
  workflow_call:
    inputs:
      buildArtifact:
        description: 'Should artifacts be compiled'
        required: false
        default: true
        type: boolean
  workflow_dispatch:

# Environment variables for the job
env:
  ADDON_PATH: openkcc/addons/openkcc
  ADDON_LIBS_PATH: openkcc/addons/openkcc/libs

jobs:
  compile:
    if: ${{ github.event_name == 'workflow_dispatch' || inputs.buildArtifact }}
    uses: ./.github/workflows/gdextension_build.yml
    with:
      buildWindows: true
      buildLinux: true
      buildMacos: true
      buildAndroid: true
      buildWeb: true

  create_package:
    runs-on: "ubuntu-20.04"
    name: ðŸ“¦ Build Package
    needs: compile
    if: |
      always() &&
      (needs.compile.result == 'success' || needs.compile.result == 'skipped')
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Download Binaries
        uses: actions/download-artifact@v3
        with:
          path: extracted_files
          name: gdextension_libs

      - name: Replace with new files
        run: |
          ls -R extracted_files
          rm -rf ${{env.ADDON_LIBS_PATH}}
          mv -f extracted_files ${{env.ADDON_LIBS_PATH}}

      - name: Upload Package
        uses: actions/upload-artifact@v3
        with:
          name: godot-openkcc
          retention-days: 7
          path: ${{env.ADDON_PATH}}/*
